<!DOCTYPE html>
<html lang="ky">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ñ—ã–ª–∞–∞–Ω √ó –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</title>
</head>

<body>
    <!-- üü¶ –ë–∞—à–∫—ã –±”©–ª“Ø–∫: –æ—é–Ω —Ç—É—É—Ä–∞–ª—É—É –∞–±–∞–ª–¥—ã –∫”©—Ä—Å”©—Ç”©—Ç -->
    <header>
        <div class="hud" aria-label="Status left">
            <!-- –†–µ–∂–∏–º–¥–∏ –∫”©—Ä—Å”©—Ç”©—Ç (–∫–æ—à—É—É, –∞–ª—É—É, –∂.–±.) -->
            <div class="chip">Mode: <b id="modeChip">‚Äî</b></div>
            <!-- –î–µ“£–≥—ç—ç–ª–¥–∏ –∫”©—Ä—Å”©—Ç”©—Ç -->
            <div class="chip">Level: <b id="levelChip">‚Äî</b></div>
        </div>

        <!-- –û—é–Ω–¥—É–Ω –∞—Ç–∞–ª—ã—à—ã -->
        <h1>üêç Snake √ó <span style="color:var(--accent)">Math</span></h1>

        <div class="hud" aria-label="Status right">
            <!-- –¢–æ–ø—Ç–æ–ª–≥–æ–Ω —É–ø–∞–π -->
            <div class="chip">Score: <b id="scoreChip">0</b></div>
            <!-- –£–±–∞–∫—ã—Ç —ç—Å–µ–ø—Ç–µ–≥–∏—á (—Ç–∞–π–º–µ—Ä) -->
            <div class="chip hidden" id="timeChipContainer">Time: <b id="timeChip">‚Äî</b></div>
            <!-- –ñ–∞–Ω–¥–∞—Ä —Å–∞–Ω—ã -->
            <div class="chip">Lives: <b id="livesChip">3</b></div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å: –º–∞—Å–µ–ª–µ –∂–∞–Ω–∞ –±–∞—à–∫–∞—Ä—É—É –±–∞—Å–∫—ã—á—Ç–∞—Ä—ã -->
        <div class="panel" role="group" aria-label="Expression & controls">
            <button class="btn" id="menuBtn" title="Main menu">‚ò∞ Menu</button>
            <div class="expr">Solve: <b id="exprText">‚Äî</b></div>
            <button class="btn" id="pauseBtn" title="Pause/Resume">‚èØ Pause</button>
        </div>
    </header>

    <div class="wrap">
        <!-- –û—é–Ω —Ç–∞–ª–∞–∞—Å—ã -->
        <div class="board-wrap" id="boardWrap">
            <!-- Canvas ‚Äî –æ—é–Ω —Ç–∞–ª–∞–∞—Å—ã (—è—á–µ–π–∫–∞–ª–∞—Ä –º–µ–Ω–µ–Ω —Å–µ—Ç–∫–∞) -->
            <canvas id="board" width="400" height="400" aria-label="Game board" tabindex="0"></canvas>

            <!-- üìã –ë–∞—à–∫—ã –º–µ–Ω—é “Ø—Å—Ç“Ø–Ω–∫“Ø –∫–∞—Ç–º–∞—Ä—ã -->
            <div class="overlay hidden" id="menu">
                <div class="card">
                    <h2>Start Game</h2>
                    <p>–†–µ–∂–∏–º –∂–∞–Ω–∞ –¥–µ“£–≥—ç—ç–ª–¥–∏ —Ç–∞–Ω–¥–∞. –ë”©–ª“Ø“Ø–¥”© –∞—Ä –¥–∞–π—ã–º –±“Ø—Ç“Ø–Ω —Å–∞–Ω —á—ã–≥–∞—Ç. –î—É–±–∞–ª–≥–∞ –∂–∞–Ω–∞ ”©–∑“Ø“£”© —É—Ä—É–Ω–±–∞. –¢—É—É—Ä–∞
                        –∂–æ–æ–ø—Ç—É –∂–µ, —Ç—É—É—Ä–∞ —ç–º–µ—Å –∂–æ–æ–ø –±–∏—Ä –∂–∞–Ω–¥—ã –∞–ª–∞—Ç.</p>
                    <div class="row">
                        <!-- –†–µ–∂–∏–º —Ç–∞–Ω–¥–æ–æ -->
                        <label>
                            <div style="margin-bottom:6px">Mode</div>
                            <select class="select" id="modeSelect">
                                <option value="add">Addition</option>
                                <option value="sub">Subtraction</option>
                                <option value="mul">Multiplication</option>
                                <option value="div">Division</option>
                                <option value="mix" selected>Mixed</option>
                            </select>
                        </label>
                        <!-- –î–µ“£–≥—ç—ç–ª —Ç–∞–Ω–¥–æ–æ -->
                        <label>
                            <div style="margin-bottom:6px">Level</div>
                            <select class="select" id="levelSelect">
                                <option value="easy">Easy (1‚Äì9)</option>
                                <option value="med">Medium (10‚Äì99)</option>
                                <option value="mix">Mixed (1‚Äì99)</option>
                                <option value="adv">Advanced (to 3 digits)</option>
                                <option value="exp" selected>Expert (fast)</option>
                            </select>
                        </label>
                    </div>
                    <!-- –û–ø—Ü–∏—è–ª–∞—Ä -->
                    <div style="margin-top:10px;">
                        <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <input type="checkbox" id="showHintsCheck" checked>
                            <span>–¢—É—É—Ä–∞ –∂–æ–æ–ø–∫–æ –∂–∞—à—ã–ª –ø–æ–¥—Å–∫–∞–∑–∫–∞ –∫”©—Ä—Å”©—Ç“Ø“Ø</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <input type="checkbox" id="timerCheck" checked>
                            <span>–¢–∞–π–º–µ—Ä–¥–∏ –∫“Ø–π–≥“Ø–∑“Ø“Ø</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:8px;">
                            <input type="checkbox" id="sandboxCheck">
                            <span>Sandbox —Ä–µ–∂–∏–º (—á–µ–∫—Å–∏–∑ –æ—é–Ω)</span>
                        </label>
                    </div>
                    <!-- –ë–∞—à–∫–∞—Ä—É—É –±–∞—Å–∫—ã—á—Ç–∞—Ä—ã -->
                    <div style="display:flex; gap:8px; margin-top:10px;">
                        <button class="btn" id="startBtn">‚ñ∂ Start</button>
                        <button class="btn" id="howBtn">‚ùì How to play</button>
                    </div>
                    <p class="notice">–ë–∞—à–∫–∞—Ä—É—É: –∂–µ–±–µ –±–∞—Å–∫—ã—á—Ç–∞—Ä / WASD ‚Ä¢ —ç–∫—Ä–∞–Ω–¥–∞–≥—ã D-pad ‚Ä¢ —Å“Ø—Ä“Ø“Ø. <span
                            class="dot"></span></p>
                </div>
            </div>

            <!-- ‚Ñπ –ö–∞–Ω—Ç–∏–ø –æ–π–Ω–æ–æ “Ø—Å—Ç“Ø–Ω–∫“Ø –∫–∞—Ç–º–∞—Ä—ã -->
            <div class="overlay hidden" id="info">
                <div class="card">
                    <h2>How to play</h2>
                    <p>–ö–ª–∞—Å—Å–∏–∫–∞–ª—ã–∫ –∂—ã–ª–∞–∞–Ω —ç—Ä–µ–∂–µ–ª–µ—Ä–∏. –ñ–æ–≥–æ—Ä–∫—É –∂–∞–∫—Ç–∞ –º–∏—Å–∞–ª —á—ã–≥–∞—Ç. –¢—É—É—Ä–∞ –∂–æ–æ–ø–∫–æ –∂–µ—Ç—Å–µ“£ —É–ø–∞–π –∫–æ—à—É–ª–∞—Ç, —Ç—É—É—Ä–∞
                        —ç–º–µ—Å –±–æ–ª—Å–æ –∂–∞–Ω –∫–µ—Ç–µ—Ç. 10 —Ç—É—É—Ä–∞ –∂–æ–æ–ø –±–µ—Ä–≥–µ–Ω–¥–µ –¥–µ“£–≥—ç—ç–ª –∞—è–∫—Ç–∞–π—Ç.</p>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <button class="btn" id="resumeFromInfo">OK</button>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ –î–µ“£–≥—ç—ç–ª –∞—è–∫—Ç–∞–¥—ã -->
            <div class="overlay hidden" id="levelDone">
                <div class="card">
                    <h2>Level Complete üéâ</h2>
                    <p>–°–µ–Ω <b id="solvedCount">0</b> –º–∏—Å–∞–ª–¥—ã —Ç—É—É—Ä–∞ —á–µ—á—Ç–∏“£! –£–ª–∞–Ω—Ç–∞—Å—ã“£–±—ã –∂–µ –∂–∞“£—ã –¥–µ“£–≥—ç—ç–ª —Ç–∞–Ω–¥–∞–π—Å—ã“£–±—ã?</p>
                    <div style="display:flex; gap:8px; margin-top:8px; flex-wrap: wrap;">
                        <button class="btn" id="continueBtn">Continue</button>
                        <button class="btn" id="changeBtn">Change Mode/Level</button>
                    </div>
                </div>
            </div>

            <!-- ‚ò† –û—é–Ω –±“Ø—Ç—Ç“Ø -->
            <div class="overlay hidden" id="gameOver">
                <div class="card">
                    <h2>Game Over üíÄ</h2>
                    <p>–°–µ–Ω–∏–Ω —É–ø–∞–π—ã“£: <b id="finalScore">0</b>. –ö–∞–π—Ä–∞ –∞—Ä–∞–∫–µ—Ç –∫—ã–ª–∞—Å—ã“£–±—ã?</p>
                    <div style="display:flex; gap:8px; margin-top:8px; flex-wrap: wrap;">
                        <button class="btn" id="retryBtn">‚Üª Retry</button>
                        <button class="btn" id="goMenuBtn">‚ò∞ Menu</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- üì± –ú–æ–±–∏–ª–¥–∏–∫ D-PAD -->
        <div class="controls" aria-label="Mobile controls">
            <button class="pad up" data-dir="up">‚ñ≤</button>
            <button class="pad left" data-dir="left">‚óÄ</button>
            <button class="pad ok" id="okBtn">‚èØ</button>
            <button class="pad right" data-dir="right">‚ñ∂</button>
            <button class="pad down" data-dir="down">‚ñº</button>
        </div>

        <div class="notice">Tip: <b>Expert</b> –¥–µ“£–≥—ç—ç–ª–¥–µ –∂—ã–ª–∞–∞–Ω –∞—Ä –±–∏—Ä –∂–æ–æ–ø—Ç–æ–Ω –∫–∏–π–∏–Ω —Ç–µ–∑–∏—Ä—ç—ç–∫ –±–æ–ª–æ—Ç.</div>
    </div>

    <script>
        // üü¶ –û—é–Ω–¥—É–Ω –Ω–µ–≥–∏–∑–≥–∏ –∫–ª–∞—Å—Å—ã
        class SnakeMathGame {
            constructor() {
                // üü© –û—é–Ω —Ç–∞–ª–∞–∞—Å—ã–Ω—ã–Ω ”©–ª—á”©–º–¥”©—Ä“Ø
                this.GRID_SIZE = 20;       // —Å–µ—Ç–∫–∞ (20√ó20)
                this.TILE_SIZE = 20;       // –∞—Ä –±–∏—Ä —è—á–µ–π–∫–∞–Ω—ã–Ω ”©–ª—á”©–º“Ø
                this.CANVAS_SIZE = this.GRID_SIZE * this.TILE_SIZE; // —Ç–∞–ª–∞–∞–Ω—ã–Ω –∫”©–ª”©–º“Ø (400√ó400)
                this.TARGET_SOLVES = 10;   // –±–∏—Ä –¥–µ“£–≥—ç—ç–ª–¥–µ —á—ã–≥–∞—Ä—ã–ª–∞ —Ç—É—Ä–≥–∞–Ω –º–∏—Å–∞–ª–¥–∞—Ä–¥—ã–Ω —Å–∞–Ω—ã
                this.START_LIVES = 3;      // –±–∞—à—Ç–∞–ø–∫—ã –∂–∞–Ω–¥–∞—Ä —Å–∞–Ω—ã

                // üñº Canvas –¥–∞—è—Ä–¥–æ–æ
                this.canvas = document.getElementById('board');
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = this.CANVAS_SIZE;
                this.canvas.height = this.CANVAS_SIZE;
                this.ctx.imageSmoothingEnabled = false; // –ø–∏–∫—Å–µ–ª–¥–∏ –∂—É–º—à–∞—Ä—Ç–ø–∞–π–±—ã–∑

                // üìä –û—é–Ω –∞–±–∞–ª—ã ‚Äî –±–∞—Ä–¥—ã–∫ –º–∞–∞–Ω–∏–ª“Ø“Ø –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä —É—à—É–ª –æ–±—ä–µ–∫—Ç—Ç–µ —Å–∞–∫—Ç–∞–ª–∞—Ç
                this.gameState = {
                    running: false,      // –æ—é–Ω –∏—à—Ç–µ–ø –∂–∞—Ç–∞–±—ã
                    paused: false,       // —Ç–æ–∫—Ç–æ—Ç—É–ª—É–ø —Ç—É—Ä–∞–±—ã
                    snake: [],           // –∂—ã–ª–∞–∞–Ω–¥—ã–Ω —Å–µ–≥–º–µ–Ω—Ç—Ç–µ—Ä–∏
                    direction: { x: 1, y: 0 },   // —É—á—É—Ä–¥–∞–≥—ã –±–∞–≥—ã—Ç (–æ“£–≥–æ)
                    nextDirection: { x: 1, y: 0 }, // –∫–∏–π–∏–Ω–∫–∏ –±–∞–≥—ã—Ç
                    growQueue: 0,        // –∂—ã–ª–∞–∞–Ω –∫–∞–Ω—á–∞–≥–∞ —á–æ“£–æ—ë—Ç
                    answerTiles: new Map(), // –∂–æ–æ–ø —è—á–µ–π–∫–∞–ª–∞—Ä—ã
                    currentAnswer: 0,    // —Ç—É—É—Ä–∞ –∂–æ–æ–ø
                    currentExpression: '‚Äî', // —á—ã–≥–∞—Ä—ã–ª–∞—Ç—É—Ä–≥–∞–Ω –º–∏—Å–∞–ª
                    mode: 'mix',         // —Ä–µ–∂–∏–º (–∫–æ—à—É—É, –∞–ª—É—É –∂.–±.)
                    level: 'exp',        // –¥–µ“£–≥—ç—ç–ª
                    score: 0,            // —É–ø–∞–π
                    lives: this.START_LIVES, // –∂–∞–Ω–¥–∞—Ä —Å–∞–Ω—ã
                    solved: 0,           // —Ç—É—É—Ä–∞ –∂–æ–æ–ø—Ç–æ—Ä —Å–∞–Ω—ã
                    tickInterval: 140,   // –∂—ã–ª–∞–∞–Ω–¥—ã–Ω —ã–ª–¥–∞–º–¥—ã–≥—ã (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥)
                    gameTimer: null,     // –æ—é–Ω —Ç–∞–π–º–µ—Ä–∏
                    flashCounter: 0,
                    showHints: true,     // —Ç—É—É—Ä–∞ –∂–æ–æ–ø—Ç—É –∫”©—Ä—Å”©—Ç“Ø“Ø
                    sandboxMode: false,  // —á–µ–∫—Å–∏–∑ —Ä–µ–∂–∏–º
                    timerEnabled: true,  // —Ç–∞–π–º–µ—Ä –∫“Ø–π“Ø–ø —Ç—É—Ä–∞–±—ã
                    timeRemaining: 0,    // –∫–∞–ª–≥–∞–Ω —É–±–∞–∫—ã—Ç
                    timerIntervalId: null, // —Ç–∞–π–º–µ—Ä–¥–∏–Ω ID
                    tilePositions: []    // –∂–æ–æ–ø —è—á–µ–π–∫–∞–ª–∞—Ä—ã–Ω—ã–Ω –∂–∞–π–≥–∞—à—É—É—Å—É
                };

                // üü® –ê—Ä –±–∏—Ä –¥–µ“£–≥—ç—ç–ª–≥–µ —Ç–∏–µ—à–µ–ª“Ø“Ø —Å–∞–Ω–¥–∞—Ä (–∫–æ—à—É—É, –∞–ª—É—É, –±”©–ª“Ø“Ø –∂.–±.)
                this.levels = {
                    easy: { add: [1, 9], sub: [1, 9], mul: [1, 9], div: [1, 9], q: [1, 9], time: 120, timeBonus: 10 },
                    med: { add: [10, 99], sub: [10, 99], mul: [2, 12], div: [2, 20], q: [2, 12], time: 100, timeBonus: 8 },
                    mix: { add: [1, 99], sub: [1, 99], mul: [2, 15], div: [2, 20], q: [2, 15], time: 90, timeBonus: 7 },
                    adv: { add: [50, 999], sub: [50, 999], mul: [10, 99], div: [3, 60], q: [3, 25], time: 75, timeBonus: 6 },
                    exp: { add: [1, 999], sub: [1, 999], mul: [5, 99], div: [3, 80], q: [3, 30], time: 60, timeBonus: 5 }
                };

                this.init(); // –æ—é–Ω–¥—É –±–∞—à—Ç–∞–ø–∫—ã –∞–±–∞–ª–≥–∞ –∫–µ–ª—Ç–∏—Ä“Ø“Ø
            }

            // üü¶ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –æ–∫—É—è —É–∫–∫—É—á—Ç–∞—Ä–¥—ã –∫–æ—é—É, ”©–∑–≥”©—Ä–º”©–ª”©—Ä–¥“Ø –∂“Ø–∫—Ç”©”©
            init() {
                this.setupEventListeners();
                this.loadSettings();
                this.showMenu();
                this.draw();
            }

            // üü¶ –ë–∞—Å–∫—ã—á—Ç–∞—Ä–¥—ã, –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–Ω—ã –∂–∞–Ω–∞ —Å–µ–Ω—Å–æ—Ä–¥—É –∏—à—Ç–µ—Ç“Ø“Ø
            setupEventListeners() {
                // üìå –ë–∞—Å–∫—ã—á—Ç–∞—Ä
                document.getElementById('menuBtn').onclick = () => this.showMenu();
                document.getElementById('pauseBtn').onclick = () => this.togglePause();
                document.getElementById('howBtn').onclick = () => this.showInfo();
                document.getElementById('resumeFromInfo').onclick = () => this.hideInfo();
                document.getElementById('startBtn').onclick = () => this.startFromMenu();
                document.getElementById('continueBtn').onclick = () => { this.hideLevelDone(); this.resume(); };
                document.getElementById('changeBtn').onclick = () => { this.hideLevelDone(); this.showMenu(); };
                document.getElementById('retryBtn').onclick = () => { this.hideGameOver(); this.startGame(); };
                document.getElementById('goMenuBtn').onclick = () => { this.hideGameOver(); this.showMenu(); };
                document.getElementById('okBtn').onclick = () => this.togglePause();

                // üìå –≠–∫—Ä–∞–Ω–¥–∞–≥—ã –∂–µ–±–µ –±–∞—Å–∫—ã—á—Ç–∞—Ä (–º–æ–±–∏–ª–¥–∏–∫ –±–∞—à–∫–∞—Ä—É—É)
                document.querySelectorAll('.pad[data-dir]').forEach(btn => {
                    btn.onclick = () => this.setDirection(btn.getAttribute('data-dir'));
                });

                // üìå –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –º–µ–Ω–µ–Ω –±–∞—à–∫–∞—Ä—É—É
                document.addEventListener('keydown', (e) => {
                    if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "].includes(e.key)) {
                        e.preventDefault(); // –±–∞—Ä–∞–∫—Ç—ã –∂—ã–ª–¥—ã—Ä–±–æ–æ
                    }

                    if (e.key === ' ') { // –ø—Ä–æ–±–µ–ª ‚Äî —Ç–æ–∫—Ç–æ—Ç—É—É/—É–ª–∞–Ω—Ç—É—É
                        this.togglePause();
                        return;
                    }

                    const keyMap = {
                        ArrowUp: 'up', ArrowDown: 'down', ArrowLeft: 'left', ArrowRight: 'right',
                        w: 'up', W: 'up', s: 'down', S: 'down',
                        a: 'left', A: 'left', d: 'right', D: 'right'
                    };

                    if (keyMap[e.key]) {
                        this.setDirection(keyMap[e.key]);
                    }
                });

                // üìå –°–µ–Ω—Å–æ—Ä –º–µ–Ω–µ–Ω –±–∞—à–∫–∞—Ä—É—É (—Å“Ø—Ä“Ø“Ø)
                let touchStart = null;
                this.canvas.addEventListener('touchstart', (e) => {
                    if (e.touches[0]) {
                        touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                        e.preventDefault(); // —Å–∫—Ä–æ–ª–ª–¥—É —Ç–æ–∫—Ç–æ—Ç–æ–±—É–∑
                    }
                }, { passive: false });

                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault(); // —Å–∫—Ä–æ–ª–ª –±–æ–ª–±–æ—à “Ø—á“Ø–Ω
                }, { passive: false });

                this.canvas.addEventListener('touchend', (e) => {
                    if (!touchStart) return;
                    e.preventDefault();

                    const touch = e.changedTouches[0];
                    const dx = touch.clientX - touchStart.x;
                    const dy = touch.clientY - touchStart.y;
                    const absX = Math.abs(dx);
                    const absY = Math.abs(dy);

                    if (Math.max(absX, absY) > 24) {
                        if (absX > absY) {
                            this.setDirection(dx > 0 ? 'right' : 'left');
                        } else {
                            this.setDirection(dy > 0 ? 'down' : 'up');
                        }
                    }
                    touchStart = null;
                }, { passive: false });
            }

            // ‚öô –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å “Ø—Å—Ç“Ø–Ω–∫“Ø –∫–∞—Ç–º–∞—Ä–ª–∞—Ä—ã–Ω –∫”©—Ä—Å”©—Ç“Ø“Ø/–∂–∞—à—ã—Ä—É—É (–º–µ–Ω—é, info, gameOver –∂.–±.)
            showMenu() { document.getElementById('menu').classList.remove('hidden'); this.pause(); }
            hideMenu() { document.getElementById('menu').classList.add('hidden'); }
            showInfo() { document.getElementById('info').classList.remove('hidden'); this.pause(); }
            hideInfo() { document.getElementById('info').classList.add('hidden'); this.resume(); }
            showLevelDone() { document.getElementById('levelDone').classList.remove('hidden'); this.pause(); }
            hideLevelDone() { document.getElementById('levelDone').classList.add('hidden'); }
            showGameOver() { document.getElementById('gameOver').classList.remove('hidden'); this.pause(); }
            hideGameOver() { document.getElementById('gameOver').classList.add('hidden'); }

            // üöÄ –ú–µ–Ω—é–¥–∞–Ω –æ—é–Ω–¥—É –±–∞—à—Ç–æ–æ
            startFromMenu() {
                this.gameState.mode = document.getElementById('modeSelect').value;
                this.gameState.level = document.getElementById('levelSelect').value;
                this.gameState.showHints = document.getElementById('showHintsCheck').checked;
                this.gameState.sandboxMode = document.getElementById('sandboxCheck').checked;
                this.gameState.timerEnabled = document.getElementById('timerCheck').checked;
                this.saveSettings();
                this.hideMenu();
                this.startGame();
            }

            // üéÆ –û—é–Ω–¥—É –∫–∞–π—Ä–∞ –±–∞—à—Ç–æ–æ (–∂–∞–Ω—ã—Ä–∞–∞–∫)
            startGame() {
                this.gameState.score = 0;
                this.gameState.lives = this.START_LIVES;
                this.gameState.solved = 0;
                this.gameState.flashCounter = 0;
                this.setupSpeed();
                this.resetSnake();
                this.spawnProblem();
                this.updateHUD();
                this.resume();

                // –¢–∞–π–º–µ—Ä –∫“Ø–π“Ø–ø —Ç—É—Ä–≥–∞–Ω –±–æ–ª—Å–æ
                if (this.gameState.timerEnabled) {
                    const levelConfig = this.levels[this.gameState.level] || this.levels.mix;
                    this.gameState.timeRemaining = levelConfig.time;
                    this.startTimer();
                }
            }

            // üü¶ –ñ—ã–ª–∞–∞–Ω–¥—ã–Ω —ã–ª–¥–∞–º–¥—ã–≥—ã–Ω –¥–µ“£–≥—ç—ç–ª–≥–µ –∂–∞—Ä–∞—à–∞ –∫–æ—é—É
            setupSpeed() {
                const speedMap = { easy: 160, med: 150, mix: 145, adv: 140, exp: 130 };
                this.gameState.tickInterval = speedMap[this.gameState.level] || 140;
            }

            // üü¶ –ñ—ã–ª–∞–∞–Ω–¥—ã –±–∞—à—Ç–∞–ø–∫—ã –∞–±–∞–ª–≥–∞ –∫–æ—é—É (–±–æ—Ä–±–æ—Ä–¥–æ–Ω —á—ã–≥–∞—Ç)
            resetSnake() {
                const center = Math.floor(this.GRID_SIZE / 2);
                this.gameState.snake = [
                    { x: center, y: center },
                    { x: center - 1, y: center },
                    { x: center - 2, y: center }
                ];
                this.gameState.direction = { x: 1, y: 0 };
                this.gameState.nextDirection = { x: 1, y: 0 };
                this.gameState.growQueue = 0;
            }

            // üü¶ –û—é–Ω–¥—É —Ç–æ–∫—Ç–æ—Ç—É—É/—É–ª–∞–Ω—Ç—É—É
            togglePause() { this.gameState.paused ? this.resume() : this.pause(); }

            pause() {
                this.gameState.paused = true;
                this.gameState.running = false;
                if (this.gameState.gameTimer) {
                    clearInterval(this.gameState.gameTimer);
                    this.gameState.gameTimer = null;
                }
                this.stopTimer();
            }

            resume() {
                const overlaysHidden = ['menu', 'info', 'gameOver', 'levelDone']
                    .every(id => document.getElementById(id).classList.contains('hidden'));

                if (overlaysHidden) {
                    this.gameState.paused = false;
                    this.runGameLoop();
                    this.startTimer();
                }
            }

            // üü¶ –ù–µ–≥–∏–∑–≥–∏ –æ—é–Ω —Ü–∏–∫–ª–∏ (–∞—Ä —Ç–∏–∫ —Å–∞–π—ã–Ω –∏—à—Ç–µ–π—Ç)
            runGameLoop() {
                if (this.gameState.gameTimer) clearInterval(this.gameState.gameTimer);
                this.gameState.running = true;
                this.gameState.gameTimer = setInterval(() => this.tick(), this.gameState.tickInterval);
            }

            // üü¶ –ë–∞–≥—ã—Ç—Ç—ã ”©–∑–≥”©—Ä—Ç“Ø“Ø
            setDirection(dir) {
                const map = {
                    up: { x: 0, y: -1 },
                    down: { x: 0, y: 1 },
                    left: { x: -1, y: 0 },
                    right: { x: 1, y: 0 }
                };
                const newDir = map[dir];
                if (!newDir) return;

                // –ñ—ã–ª–∞–∞–Ω –∞—Ä—Ç–∫–∞ –±—É—Ä—É–ª–±–∞–π—Ç
                if (this.gameState.snake.length > 1 &&
                    newDir.x === -this.gameState.direction.x &&
                    newDir.y === -this.gameState.direction.y) return;

                this.gameState.nextDirection = newDir;
            }

            // üü¶ –ö–æ–∫—É—Å—Ç—É–∫ —Å–∞–Ω –∂–∞–Ω–∞ —Ç–∞–Ω–¥–∞–ø –∞–ª—É—É
            randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
            randomChoice(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

            // üü¶ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞–ª—ã–∫ –º–∏—Å–∞–ª —Ç“Ø–∑“Ø“Ø
            generateProblem() {
                const lvl = this.levels[this.gameState.level] || this.levels.mix;
                const mode = this.gameState.mode === 'mix'
                    ? this.randomChoice(['add', 'sub', 'mul', 'div'])
                    : this.gameState.mode;

                let a, b, ans, op;
                switch (mode) {
                    case 'add': a = this.randomInt(...lvl.add); b = this.randomInt(...lvl.add); ans = a + b; op = '+'; break;
                    case 'sub': a = this.randomInt(...lvl.sub); b = this.randomInt(...lvl.sub); if (b > a) [a, b] = [b, a]; ans = a - b; op = '‚àí'; break;
                    case 'mul': a = this.randomInt(...lvl.mul); b = this.randomInt(...lvl.mul); ans = a * b; op = '√ó'; break;
                    case 'div': b = this.randomInt(...lvl.div); const q = this.randomInt(...lvl.q); a = b * q; ans = q; op = '√∑'; break;
                }
                return { a, b, operator: op, answer: ans, expression: `${a} ${op} ${b}` };
            }

            // üü¶ –ñ–æ–æ–ø —è—á–µ–π–∫–∞–ª–∞—Ä—ã–Ω –∫–æ—é—É
            spawnProblem() {
                const prob = this.generateProblem();
                this.gameState.currentAnswer = prob.answer;
                this.gameState.currentExpression = prob.expression;

                // —ç–≥–µ—Ä —è—á–µ–π–∫–∞ –∂–æ–∫ –±–æ–ª—Å–æ –∂–∞“£—ã–ª–∞—Ä—ã–Ω —Ç“Ø–∑”©–±“Ø–∑
                if (this.gameState.tilePositions.length === 0 || this.gameState.answerTiles.size === 0)
                    this.generateTilePositions();

                // –∂–æ–æ–ø —è—á–µ–π–∫–∞–ª–∞—Ä—ã–Ω —Ç–æ–ª—Ç—É—Ä—É—É
                this.gameState.answerTiles.clear();
                const shuffled = [...this.gameState.tilePositions].sort(() => Math.random() - 0.5);

                // —Ç—É—É—Ä–∞ –∂–æ–æ–ø
                this.gameState.answerTiles.set(shuffled[0], prob.answer);

                // –∞–¥–∞—à—Ç—ã—Ä—É—É—á—É –∂–æ–æ–ø—Ç–æ—Ä
                const distractors = [...this.generateDistractors(prob.answer, prob.operator)];
                for (let i = 1; i < shuffled.length && i - 1 < distractors.length; i++) {
                    this.gameState.answerTiles.set(shuffled[i], distractors[i - 1]);
                }
                this.updateHUD();
            }

            // üü¶ –ê–¥–∞—à—Ç—ã—Ä—É—É—á—É –∂–æ–æ–ø—Ç–æ—Ä–¥—É —Ç“Ø–∑“Ø“Ø
            generateDistractors(ans, op) {
                const set = new Set();
                const variations = [1, 2, 3, 5, 10, this.randomInt(2, 12)];

                for (let i = 0; i < 100 && set.size < 3; i++) {
                    let d = Math.random() < 0.5 ? ans + this.randomChoice(variations) : ans - this.randomChoice(variations);
                    if (op === '√ó' || op === '√∑') if (Math.random() < 0.5) d = Math.round(ans * (Math.random() < 0.5 ? 2 : 0.5));
                    d = Math.abs(Math.round(d));
                    if (d !== ans && d > 0) set.add(d);
                }
                return set;
            }

            // üü¶ –ñ–æ–æ–ø —è—á–µ–π–∫–∞–ª–∞—Ä—ã–Ω—ã–Ω –∂–∞–π–≥–∞—à—É—É—Å—É
            generateTilePositions() {
                this.gameState.tilePositions = [];
                const occupied = new Set(this.gameState.snake.map(s => `${s.x},${s.y}`));

                for (let n = 0; n < 4; n++) {
                    for (let i = 0; i < 200; i++) {
                        const x = this.randomInt(0, this.GRID_SIZE - 1), y = this.randomInt(0, this.GRID_SIZE - 1);
                        const k = `${x},${y}`;
                        if (!occupied.has(k) && !this.gameState.tilePositions.includes(k)) {
                            this.gameState.tilePositions.push(k); break;
                        }
                    }
                }
                this.gameState.tilePositions.sort(() => Math.random() - 0.5);
            }

            // üü¶ –ù–µ–≥–∏–∑–≥–∏ —Ç–∏–∫ (–æ—é–Ω –±–∏—Ä –∫–∞–¥–∞–º –∞–ª–¥—ã–≥–∞ –∂—ã–ª–∞—Ç)
            tick() {
                if (this.gameState.paused || !this.gameState.running) return;

                // –∂–∞“£—ã –±–∞—à –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
                this.gameState.direction = { ...this.gameState.nextDirection };
                const head = this.gameState.snake[0];
                const nx = head.x + this.gameState.direction.x, ny = head.y + this.gameState.direction.y;

                // –¥—É–±–∞–ª–≥–∞ —É—Ä—É–Ω—Å–∞
                if (nx < 0 || ny < 0 || nx >= this.GRID_SIZE || ny >= this.GRID_SIZE) { this.loseLife('wall'); return; }

                // ”©–∑“Ø –º–µ–Ω–µ–Ω —É—Ä—É–Ω—Å–∞
                if (this.gameState.snake.some(s => s.x === nx && s.y === ny)) { this.loseLife('self'); return; }

                this.gameState.snake.unshift({ x: nx, y: ny });
                const tile = `${nx},${ny}`;
                let ate = false;

                // –∂–æ–æ–ø —Ç–∞–π–ª—ã–Ω–∞ —É—Ä—É–Ω–¥—É
                if (this.gameState.answerTiles.has(tile)) {
                    const val = this.gameState.answerTiles.get(tile);
                    if (val === this.gameState.currentAnswer) {
                        ate = true; this.gameState.score += 10; this.gameState.solved++; this.gameState.growQueue++;
                        if (this.gameState.timerEnabled) this.gameState.timeRemaining += (this.levels[this.gameState.level] || this.levels.mix).timeBonus;
                        if (this.gameState.level === 'exp' && this.gameState.tickInterval > 70) { this.gameState.tickInterval -= 3; this.runGameLoop(); }
                        if (!this.gameState.sandboxMode && this.gameState.solved >= this.TARGET_SOLVES) { this.updateHUD(); this.showLevelDone(); return; }
                    } else { this.loseLife('wrong'); return; }

                    this.gameState.answerTiles.delete(tile);
                    if (this.gameState.answerTiles.size === 0) { this.gameState.tilePositions = []; this.spawnProblem(); }
                    else if (ate) { this.spawnProblem(); }
                }

                // –∂—ã–ª–∞–∞–Ω–¥—ã–Ω —É–∑—É–Ω–¥—É–≥—É
                if (ate || this.gameState.growQueue > 0) { if (!ate) this.gameState.growQueue--; }
                else this.gameState.snake.pop();

                this.updateHUD(); this.draw();
            }

            // üü¶ –ñ–∞–Ω–¥—ã –∂–æ–≥–æ—Ç—É—É
            loseLife(reason) {
                this.pause(); this.gameState.lives--; this.gameState.flashCounter = 6;
                if (this.gameState.lives <= 0) { this.updateHUD(); this.draw(); this.showGameOver(); return; }
                this.updateHUD(); this.resetSnake();
                this.draw();
                setTimeout(() => { if (this.gameState.lives > 0) this.resume(); }, 1000);
            }

            // üü¶ –°“Ø—Ä”©—Ç —Ç–∞—Ä—Ç—É—É (–∂—ã–ª–∞–∞–Ω, —Ç–∞–π–ª–¥–∞—Ä, –ø–æ–¥—Å–∫–∞–∑–∫–∞)
            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                if (this.gameState.flashCounter > 0) { this.ctx.fillStyle = `rgba(239,68,68,.2)`; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height); this.gameState.flashCounter--; }

                // –∂–æ–æ–ø —è—á–µ–π–∫–∞–ª–∞—Ä—ã–Ω —Ç–∞—Ä—Ç—É—É
                this.ctx.textAlign = 'center'; this.ctx.textBaseline = 'middle'; this.ctx.font = '16px monospace';
                this.gameState.answerTiles.forEach((val, key) => {
                    const [x, y] = key.split(',').map(Number);
                    const px = x * this.TILE_SIZE + this.TILE_SIZE / 2, py = y * this.TILE_SIZE + this.TILE_SIZE / 2;
                    const correct = val === this.gameState.currentAnswer;
                    const hint = this.gameState.showHints && correct;

                    this.ctx.fillStyle = hint ? 'rgba(34,197,94,.12)' : 'rgba(110,231,255,.1)';
                    this.ctx.fillRect(x * this.TILE_SIZE + 3, y * this.TILE_SIZE + 3, this.TILE_SIZE - 6, this.TILE_SIZE - 6);
                    this.ctx.strokeStyle = hint ? 'rgba(34,197,94,.5)' : 'rgba(110,231,255,.25)';
                    this.ctx.strokeRect(x * this.TILE_SIZE + 3.5, y * this.TILE_SIZE + 3.5, this.TILE_SIZE - 7, this.TILE_SIZE - 7);
                    this.ctx.fillStyle = hint ? '#22c55e' : '#9bd9ff';
                    this.ctx.fillText(String(val), px, py);
                });

                // –∂—ã–ª–∞–∞–Ω–¥—ã —Ç–∞—Ä—Ç—É—É
                for (let i = this.gameState.snake.length - 1; i >= 0; i--) {
                    const seg = this.gameState.snake[i], head = i === 0;
                    this.ctx.fillStyle = head ? '#6ee7ff' : '#94a3b8';
                    const pad = head ? 2 : 3;
                    this.ctx.fillRect(seg.x * this.TILE_SIZE + pad, seg.y * this.TILE_SIZE + pad, this.TILE_SIZE - 2 * pad, this.TILE_SIZE - 2 * pad);
                }
            }

            // üü¶ HUD –∂–∞“£—ã—Ä—Ç—É—É (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—Ç–µ–≥–∏ —É–ø–∞–π, –∂–∞–Ω, —É–±–∞–∫—ã—Ç –∂.–±.)
            updateHUD() {
                document.getElementById('modeChip').textContent = { add: 'Addition', sub: 'Subtraction', mul: 'Multiplication', div: 'Division', mix: 'Mixed' }[this.gameState.mode];
                document.getElementById('levelChip').textContent = { easy: 'Easy', med: 'Medium', mix: 'Mixed', adv: 'Advanced', exp: 'Expert' }[this.gameState.level];
                document.getElementById('scoreChip').textContent = this.gameState.score;
                document.getElementById('livesChip').textContent = this.gameState.lives;
                document.getElementById('exprText').textContent = this.gameState.currentExpression;
                document.getElementById('solvedCount').textContent = this.gameState.solved;
                document.getElementById('finalScore').textContent = this.gameState.score;

                if (this.gameState.timerEnabled) {
                    document.getElementById('timeChipContainer').classList.remove('hidden');
                    const m = Math.floor(this.gameState.timeRemaining / 60), s = this.gameState.timeRemaining % 60;
                    document.getElementById('timeChip').textContent = `${m}:${s.toString().padStart(2, '0')}`;
                } else document.getElementById('timeChipContainer').classList.add('hidden');
            }

            // üü¶ ”®–∑–≥”©—Ä–º”©–ª”©—Ä–¥“Ø —Å–∞–∫—Ç–æ–æ/–∂“Ø–∫—Ç”©”© (–ª–æ–∫–∞–ª–¥—É—É —ç—Å)
            loadSettings() {
                const m = localStorage.getItem('snakemath.mode'), l = localStorage.getItem('snakemath.level'), t = localStorage.getItem('snakemath.timer');
                if (m) document.getElementById('modeSelect').value = m;
                if (l) document.getElementById('levelSelect').value = l;
                if (t !== null) document.getElementById('timerCheck').checked = t === 'true';
            }
            saveSettings() {
                localStorage.setItem('snakemath.mode', this.gameState.mode);
                localStorage.setItem('snakemath.level', this.gameState.level);
                localStorage.setItem('snakemath.timer', this.gameState.timerEnabled);
            }

            // üü¶ –¢–∞–π–º–µ—Ä –ª–æ–≥–∏–∫–∞—Å—ã
            startTimer() {
                if (!this.gameState.timerEnabled || this.gameState.timerIntervalId || this.gameState.paused) return;
                this.gameState.timerIntervalId = setInterval(() => this.updateTimer(), 1000);
            }
            stopTimer() { if (this.gameState.timerIntervalId) { clearInterval(this.gameState.timerIntervalId); this.gameState.timerIntervalId = null; } }
            updateTimer() {
                if (this.gameState.timeRemaining > 0) { this.gameState.timeRemaining--; this.updateHUD(); }
                else { this.stopTimer(); this.loseLife('time'); }
            }
        }

        // üü¶ –û—é–Ω–¥—É –∏—à–∫–µ –∫–∏—Ä–≥–∏–∑“Ø“Ø
        const game = new SnakeMathGame();
        window.SnakeMath = game; // –±—Ä–∞—É–∑–µ—Ä –∫–æ–Ω—Å–æ–ª—å–¥–æ–Ω —Ç–µ–∫—à–µ—Ä“Ø“Ø “Ø—á“Ø–Ω
    </script>

</body>

</html>